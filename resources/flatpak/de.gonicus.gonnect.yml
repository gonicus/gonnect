id: de.gonicus.gonnect
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
base: io.qt.qtwebengine.BaseApp
base-version: '6.10'
command: gonnect

add-extensions:
  de.gonicus.gonnect.plugin:
    version: "2"
    directory: plugins
    subdirectories: true
    no-autodownload: true
    autodelete: true
  de.gonicus.gonnect.provisioning:
    directory: etc/gonnect
    no-autodownload: true

finish-args:
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --device=all
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pcsc
  - --socket=pulseaudio
  - --share=network
  - --share=ipc
  # Lock screensaver while on the phone/in a conference
  - --talk-name=org.freedesktop.ScreenSaver
  # MPRIS media control
  - --talk-name=org.mpris.MediaPlayer2.*
  # KDE Systray Icon/Menu
  - --talk-name=org.kde.StatusNotifierWatcher
  # Evolution Dataserver contact source
  - --talk-name=org.gnome.evolution.dataserver.AddressBook10
  - --talk-name=org.gnome.evolution.dataserver.Calendar8
  - --talk-name=org.gnome.evolution.dataserver.Sources5
  - --talk-name=org.gnome.evolution.dataserver.Subprocess.Backend.*
  # Access for evolution-data-server avatars
  - --filesystem=xdg-data/evolution/addressbook/system/photos:ro
  # Access to music folder for ring tones
  - --filesystem=xdg-music:ro
  # Place to save download chat attachments
  - --filesystem=xdg-download:rw
  # Kerberos socket
  - --filesystem=/run/.heim_org.h5l.kcm-socket

modules:
  - name: kerberos
    subdir: src
    config-opts:
      - --localstatedir=/var/lib
      - --sbindir=${FLATPAK_DEST}/bin
      - --disable-rpath
      - --disable-static
    cleanup:
      - /bin
      - /share/et
      - /share/examples
      - /share/man
    post-install:
      - install -Dm644 ../krb5.conf -t ${FLATPAK_DEST}/etc/
    sources:
      - type: archive
        url: https://kerberos.org/dist/krb5/1.22/krb5-1.22.1.tar.gz
        sha256: 1a8832b8cad923ebbf1394f67e2efcf41e3a49f460285a66e35adec8fa0053af
        x-checker-data:
          type: anitya
          project-id: 13287
          stable-only: true
          url-template: https://kerberos.org/dist/krb5/${major}.${minor}/krb5-${major}.${minor}.${patch}.tar.gz
      - type: file
        path: krb5.conf

  - name: pjsip
    buildsystem: autotools
    config-opts:
      - --disable-video
      - --enable-ext-sound
      - --with-opus
      - CFLAGS=-fPIC -DPJ_HAS_IPV6=1 -DPJSIP_MAX_PKT_LEN=8192
    sources:
      - type: git
        url: https://github.com/pjsip/pjproject.git
        tag: "2.16"
        commit: 6cab30cec44af36ba7c8a45ff7af2f74a8ed288c
        x-checker-data:
          type: git
          tag-pattern: ^([0-9]+\.[0-9]+\.[0-9]+)$

  - name: openldap
    config-opts:
      - --disable-static
      - --disable-slapd
      - --disable-slurpd
      - --disable-bdb
      - --disable-hdb
      - --with-tls=openssl
    cleanup:
      - /bin
      - /share/man
    sources:
      - type: archive
        url: https://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-2.6.10.tgz
        sha256: c065f04aad42737aebd60b2fe4939704ac844266bc0aeaa1609f0cad987be516
        x-checker-data:
          type: anitya
          stable-only: true
          project-id: 2551
          url-template: "https://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-${major}.${minor}.${patch}.tgz"

  - name: qtwebdav
    buildsystem: cmake-ninja
    config-opts:
    - -DBUILD_WITH_QT6=ON
    sources:
      - type: git
        url: https://github.com/PikachuHy/QtWebDAV.git
        commit: ac39687b8ae16118d385d3694e900becd108a0f2
      - type: patch
        path: patches/qtwebdav-cmake.patch

  - name: libsecret
    buildsystem: meson
    config-opts:
      - -Dmanpage=false
      - -Dvapi=false
      - -Dgtk_doc=false
      - -Dintrospection=false
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libsecret/0.21/libsecret-0.21.7.tar.xz
        sha256: 6b452e4750590a2b5617adc40026f28d2f4903de15f1250e1d1c40bfd68ed55e
        x-checker-data:
          type: gnome
          name: libsecret
          stable-only: true
    cleanup:
    - /bin
    - /share/man

  - name: qtkeychain
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
    - -DBUILD_WITH_QT6=ON
    sources:
      - type: git
        url: https://github.com/frankosterfeld/qtkeychain.git
        tag: 0.15.0
        commit: ad7344c45a86a4f66cbafc4b081b5f7b876cb0b7
        x-checker-data:
          type: git
          tag-pattern: ^([0-9]+\.[0-9]+\.[0-9]+)$

  - name: libical
    cleanup:
      - /lib/cmake
      - /libexec
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_LIBDIR=lib
      - -DBUILD_SHARED_LIBS:BOOL=ON
      - -DICAL_GLIB=true
      - -DGOBJECT_INTROSPECTION=true
      - -DICAL_GLIB_VAPI=false
      - -DICAL_BUILD_DOCS=false
    sources:
      - type: archive
        url: https://github.com/libical/libical/releases/download/v3.0.20/libical-3.0.20.tar.gz
        sha256: e73de92f5a6ce84c1b00306446b290a2b08cdf0a80988eca0a2c9d5c3510b4c2
        x-checker-data:
          type: anitya
          project-id: 1637
          url-template: https://github.com/libical/libical/releases/download/v$version/libical-$version.tar.gz

  - name: evolution-data-server
    cleanup:
      - /lib/cmake
      - /lib/systemd
      - /lib/evolution-data-server/*-backends
      - /libexec
      - /share/applications
      - /share/dbus-1/services
      - /share/evolution-data-server
      - /share/pixmaps
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DENABLE_GTK=OFF
      - -DENABLE_GTK4=OFF
      - -DENABLE_GOA=OFF
      - -DENABLE_UOA=OFF
      - -DENABLE_GOOGLE_AUTH=OFF
      - -DENABLE_GOOGLE=OFF
      - -DENABLE_WITH_PHONENUMBER=OFF
      - -DENABLE_VALA_BINDINGS=OFF
      - -DENABLE_WEATHER=OFF
      - -DWITH_OPENLDAP=OFF
      - -DWITH_LIBDB=OFF
      - -DENABLE_INTROSPECTION=ON
      - -DENABLE_INSTALLED_TESTS=OFF
      - -DENABLE_GTK_DOC=OFF
      - -DENABLE_EXAMPLES=OFF
      - -DENABLE_CANBERRA=OFF
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://download.gnome.org/sources/evolution-data-server/3.59/evolution-data-server-3.59.1.tar.xz
        sha256: f4c178f6f87b4a44ddc553da636b7e874eb3ab93661d3f5ca3400ec9cb1c5f50
        x-checker-data:
          type: gnome
          name: evolution-data-server
    modules:
      - shared-modules/intltool/intltool-0.51.json

  - name: vcard
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/ivanenko/vCard.git
        commit: 9e6a5349d27733c931815b2e236807f3414ab251
      - type: patch
        path: patches/vcard-cmake.patch

  - shared-modules/libusb/libusb.json

  - name: hidapi
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/libusb/hidapi.git
        tag: hidapi-0.15.0
        commit: d6b2a974608dec3b76fb1e36c189f22b9cf3650c
        x-checker-data:
          type: git
          tag-pattern: ^(hidapi-[0-9.]+)$

  - name: logfault
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/jgaa/logfault.git
        tag: v0.8.1
        commit: 9851bceb50e53de21cbbf27fef0b79c19667d3ec
        x-checker-data:
          type: git
          tag-pattern: ^(v[0-9.]+)$

  - name: gonnect
    buildsystem: cmake-ninja
    config-opts:
    - -DCMAKE_MODULE_PATH=/app/lib/${FLATPAK_ARCH}-linux-gnu/cmake/Qt6
    - -DCMAKE_LIBRARY_PATH=/usr/lib
    - -DCMAKE_INSTALL_RPATH=/usr/lib
    - -DCMAKE_UNITY_BUILD=ON
    - -DCMAKE_OPTIMIZE_DEPENDENCIES=ON
    - -DENABLE_GOW_002=ON
    - -DENABLE_GOW_003=ON
    - -DENABLE_PCH=ON
    sources:
    - type: dir
      path: ../..
    cleanup:
    - /bin/update-emojis

cleanup-commands:
  - /app/cleanup-BaseApp.sh
  - mkdir -p ${FLATPAK_DEST}/plugins
  - mkdir -p ${FLATPAK_DEST}/etc/gonnect
